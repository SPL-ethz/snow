

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ethz_snow.snowing &mdash; ethz_snow 1.1.0.post1.dev34+ga1dec07.d20230707 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="ethz_snow 1.1.0.post1.dev34+ga1dec07.d20230707 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> ethz_snow
          

          
          </a>

          
            
            
              <div class="version">
                1.1.0.post1.dev34+ga1dec07.d20230707
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">Module Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ethz_snow</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>ethz_snow.snowing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ethz_snow.snowing</h1><div class="highlight"><pre>
<span></span><span class="c1">#  ____     _   _     ___    __        __   _</span>
<span class="c1"># / ___|   | \ | |   / _ \   \ \      / /  (_)   _ __      __ _</span>
<span class="c1"># \___ \   |  \| |  | | | |   \ \ /\ / /   | |  | &#39;_ \    / _` |</span>
<span class="c1">#  ___) |  | |\  |  | |_| |    \ V  V /    | |  | | | |  | (_| |</span>
<span class="c1"># |____/   |_| \_|   \___/      \_/\_/     |_|  |_| |_|   \__, |</span>
<span class="c1">#                                                         |___/</span>

<span class="sd">&quot;&quot;&quot;Implementation of the SNOWing class.</span>

<span class="sd">This module contains the SNOWing class used to run the single vial simulation</span>
<span class="sd">with spatial information.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">simps</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
<span class="kn">from</span> <span class="nn">matplotlib.legend_handler</span> <span class="kn">import</span> <span class="n">HandlerTuple</span>

<span class="kn">import</span> <span class="nn">ethz_snow.utils</span> <span class="k">as</span> <span class="nn">Utils</span>
<span class="kn">from</span> <span class="nn">ethz_snow.constants</span> <span class="kn">import</span> <span class="n">calculateDerived</span>
<span class="kn">from</span> <span class="nn">ethz_snow.operatingConditions</span> <span class="kn">import</span> <span class="n">OperatingConditions</span>

<span class="n">HEATFLOW_REQUIREDKEYS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;ext&quot;</span><span class="p">,</span> <span class="s2">&quot;s0&quot;</span><span class="p">)</span>
<span class="n">VIAL_GROUPS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;corner&quot;</span><span class="p">,</span> <span class="s2">&quot;edge&quot;</span><span class="p">,</span> <span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="Snowing"><a class="viewcode-back" href="../../api/ethz_snow.html#ethz_snow.snowing.Snowing">[docs]</a><span class="k">class</span> <span class="nc">Snowing</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class to handle a single SNOWing (Stochastic Nucleation of Water</span>
<span class="sd">     with INternal Gradients) simulation.</span>

<span class="sd">    More information regarding the equations and their derivation can be found in</span>
<span class="sd">    XXX, Deck et al. (2023).</span>

<span class="sd">    Parameters:</span>
<span class="sd">        k (dict): Heat transfer coefficients.</span>
<span class="sd">        opcond (OperatingConditions): Operating conditions of the run.</span>
<span class="sd">        temperature (str): Model dimensionality.</span>
<span class="sd">        configuration (str): Freezing configuration.</span>
<span class="sd">        plotting (bool): Whether evolutions are plotted or not.</span>
<span class="sd">        Nrep (int): Number of repetitions.</span>
<span class="sd">        configPath (Optional[str]): The path of the (optional) custom config yaml.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;int&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ext&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;s0&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;s_sigma_rel&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="n">opcond</span><span class="p">:</span> <span class="n">OperatingConditions</span> <span class="o">=</span> <span class="n">OperatingConditions</span><span class="p">(),</span>
        <span class="n">Nrep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">configPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a Snowing object.</span>

<span class="sd">        Args:</span>
<span class="sd">            k (dict, optional): Heat transfer coefficients.</span>
<span class="sd">                Defaults to {&quot;int&quot;: 0, &quot;ext&quot;: 0, &quot;s0&quot;: 50, &quot;s_sigma_rel&quot;: 0}.</span>
<span class="sd">            opcond (OperatingConditions, optional):</span>
<span class="sd">                Operating conditions of the run. Defaults to OperatingConditions().</span>
<span class="sd">            Nrep (int, optional): Number of repetitions. Defaults to 1.</span>
<span class="sd">            configPath (Optional[str], optional): The path of the (optional)</span>
<span class="sd">                custom config yaml. Defaults to None.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If k is not a dict.</span>
<span class="sd">            ValueError: If a aspecific key is missing in dict k.</span>
<span class="sd">            TypeError: If opcond is not of type operatingConditions.</span>

<span class="sd">        Examples:</span>
<span class="sd">            The following command will create and instance of the Snowing class with</span>
<span class="sd">            default operating conditions and heat transfer parameters:</span>

<span class="sd">            &gt;&gt;&gt; S = Snowing()</span>

<span class="sd">            To customize the operating conditions, first define the operating conditions</span>
<span class="sd">            and the heat transfer parameters:</span>

<span class="sd">            &gt;&gt;&gt; d = {&quot;int&quot;: 0, &quot;ext&quot;: 0, &quot;s0&quot;: 50, &quot;s_sigma_rel&quot;: 0}</span>
<span class="sd">            &gt;&gt;&gt; c = {&quot;rate&quot;: 0.5 / 60, &quot;start&quot;: 20, &quot;end&quot;: -50}</span>
<span class="sd">            &gt;&gt;&gt; h = [dict(duration=60*60, temp=-10)]</span>
<span class="sd">            &gt;&gt;&gt; op = OperatingConditions(t_tot=5*3600, cooling=c, holding=h)</span>

<span class="sd">            Then an instance of the Snowing class can be created:</span>

<span class="sd">            &gt;&gt;&gt; S = Snowing(k=d, opcond=op)</span>

<span class="sd">            See tutorial for more information on how to use the spatial model functionalities.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input k must be of type dict. Was given </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">key</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">HEATFLOW_REQUIREDKEYS</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;A required key was missing from dictionary k, specifically &quot;</span>
                    <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">HEATFLOW_REQUIREDKEYS</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>

        <span class="c1"># for saving the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_domain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shelfTemp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iceMassFraction</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># dictionary of results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># number of repetitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span> <span class="o">=</span> <span class="n">Nrep</span>

        <span class="c1"># dictionary of results for multiple simulations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_statsMultiple</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># path to the parameters file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configPath</span> <span class="o">=</span> <span class="n">configPath</span>

        <span class="c1"># simulation progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulationStatus</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># operating conditions</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opcond</span><span class="p">,</span> <span class="n">OperatingConditions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Input opcond must be an instance of class OperatingConditions.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opcond</span> <span class="o">=</span> <span class="n">opcond</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">configPath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get configPath property.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configPath</span>

    <span class="nd">@configPath</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">configPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set configPath property.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">const</span> <span class="o">=</span> <span class="n">calculateDerived</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configPath</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">simulationStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return simulation status of instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Simulation status. 0 = not run, 1 = run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulationStatus</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulationStatus</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulationStatus</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return time array in the simulation of instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Time array in hours.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulationStatus</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Simulation not yet carried out or completed.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">temp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return temperature evolution in the simulation of instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Temperature evolution in °C.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulationStatus</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Simulation not yet carried out or completed.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shelfTemp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return shelf temperature evolution in the simulation of instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Shelf temperature evolution in °C.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulationStatus</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shelfTemp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Simulation not yet carried out or completed.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shelfTemp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">iceMassFraction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return ice mass fraction evolution in simulation of instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Ice mass fraction evolution (no units).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulationStatus</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iceMassFraction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Simulation not yet carried out or completed.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iceMassFraction</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return minimum, mean, kinetic mean and maximum nucleation temperature</span>
<span class="sd">            in simulation of instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: 4 values of nucleation temperature (minimum, kinetic mean,</span>
<span class="sd">            mean and maximum). Irrelevant for homogeneous model simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulationStatus</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">),</span> <span class="s2">&quot;Simulation not yet carried out or completed.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats_df</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_statsMultiple_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_statsMultiple</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_statsMultiple_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statsMultiple_df</span>

    <span class="c1"># simulate the entire process</span>
<div class="viewcode-block" id="Snowing.run"><a class="viewcode-back" href="../../api/ethz_snow.html#ethz_snow.snowing.Snowing.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;async&quot;</span><span class="p">):</span>
        <span class="c1"># homogeneous model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;dimensionality&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;homogeneous&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_0D</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;sequential&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_run_0D</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;async&quot;</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap_async</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_run_0D</span><span class="p">,</span>
                            <span class="p">[(</span><span class="n">i</span><span class="p">,)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span><span class="p">)],</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_statsMultiple</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">r</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">)}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;T_nuc&quot;</span><span class="p">,</span> <span class="s2">&quot;t_nuc&quot;</span><span class="p">,</span> <span class="s2">&quot;t_sol&quot;</span><span class="p">,</span> <span class="s2">&quot;t_fr&quot;</span><span class="p">]</span>

        <span class="c1"># 1D spatial model</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;dimensionality&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;spatial_1D&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_1D</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;sequential&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_run_1D</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;async&quot;</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap_async</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_run_1D</span><span class="p">,</span>
                            <span class="p">[(</span><span class="n">i</span><span class="p">,)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span><span class="p">)],</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_statsMultiple</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">r</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">)}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;T_nuc_min&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;T_nuc_kin&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;T_nuc_mean&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;T_nuc_max&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;t_nuc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;t_sol&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;t_fr&quot;</span><span class="p">,</span>
                <span class="p">]</span>

        <span class="c1"># 2D spatial model</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;dimensionality&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;spatial_2D&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_run_2D</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;sequential&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_run_2D</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;async&quot;</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap_async</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_run_2D</span><span class="p">,</span>
                            <span class="p">[(</span><span class="n">i</span><span class="p">,)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span><span class="p">)],</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_statsMultiple</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">r</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">)}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;T_nuc_min&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;T_nuc_kin&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;T_nuc_mean&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;T_nuc_max&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;t_nuc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;t_sol&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;t_fr&quot;</span><span class="p">,</span>
                <span class="p">]</span>
        <span class="c1"># update simulation status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulationStatus</span> <span class="o">=</span> <span class="mi">1</span></div>

    <span class="c1"># -------------------------------------------------------------------------- #</span>
    <span class="c1"># 0D implementation of the freezing model</span>
    <span class="c1"># -------------------------------------------------------------------------- #</span>

    <span class="c1"># homogeneous model</span>
    <span class="k">def</span> <span class="nf">_run_0D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># write into local vars for convenience: geometry</span>
        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">]</span>

        <span class="c1"># density</span>
        <span class="n">rho_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;rho_l&quot;</span><span class="p">]</span>

        <span class="c1"># mass of individual components</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span>
        <span class="n">mass_water</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;mass_water&quot;</span><span class="p">]</span>
        <span class="n">mass_solute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;mass_solute&quot;</span><span class="p">]</span>

        <span class="c1"># solute mass fraction</span>
        <span class="n">w_s</span> <span class="o">=</span> <span class="n">mass_solute</span> <span class="o">/</span> <span class="n">mass</span>

        <span class="c1"># specific heat capacities</span>
        <span class="n">cp_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;cp_w&quot;</span><span class="p">]</span>
        <span class="n">cp_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;cp_i&quot;</span><span class="p">]</span>
        <span class="n">cp_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;cp_s&quot;</span><span class="p">]</span>
        <span class="n">cp_solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;cp_solution&quot;</span><span class="p">]</span>

        <span class="c1"># soluton concentration and freezing-point depression</span>
        <span class="n">solid_fraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;solid_fraction&quot;</span><span class="p">]</span>
        <span class="n">T_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;T_eq&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">273.15</span>
        <span class="n">k_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;k_f&quot;</span><span class="p">]</span>
        <span class="n">M_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;M_s&quot;</span><span class="p">]</span>
        <span class="n">depression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;depression&quot;</span><span class="p">]</span>
        <span class="n">T_eq_l</span> <span class="o">=</span> <span class="n">T_m</span> <span class="o">-</span> <span class="n">depression</span>

        <span class="c1"># nucleation kinetics</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;kb&quot;</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span>

        <span class="c1"># latent heat of fusion</span>
        <span class="n">Dh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;Dh&quot;</span><span class="p">]</span>

        <span class="c1"># heat transfer coefficient shelf</span>
        <span class="n">K_shelf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="s2">&quot;s0&quot;</span><span class="p">]</span>

        <span class="c1"># time step</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># [s]</span>

        <span class="c1"># initial temperature</span>
        <span class="n">T_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opcond</span><span class="o">.</span><span class="n">cooling</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">273.15</span>
        <span class="n">T_k</span> <span class="o">=</span> <span class="n">T_0</span>  <span class="c1"># [K] temperature profile at t = T_old</span>
        <span class="n">T_new</span> <span class="o">=</span> <span class="n">T_k</span>

        <span class="c1"># shelf temperature and coooling rate</span>
        <span class="n">T_shelf_cool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opcond</span><span class="o">.</span><span class="n">tempProfile</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="mf">273.15</span>

        <span class="c1"># preallocation of results array</span>
        <span class="n">T_product_cooling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">T_shelf_cool</span><span class="p">)</span>
        <span class="n">time_cooling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">T_shelf_cool</span><span class="p">)</span>

        <span class="c1"># initial temperature</span>
        <span class="n">T_old</span> <span class="o">=</span> <span class="n">T_0</span>

        <span class="c1"># random numbers</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">F_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>

        <span class="c1"># preallocate the expected number of nuclei</span>
        <span class="n">E_t</span><span class="p">,</span> <span class="n">Nt_cool_end</span><span class="p">,</span> <span class="n">Nt_sol_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># solving for the cooling stage</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">T_shelf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">T_shelf_cool</span><span class="p">):</span>
            <span class="c1"># computing new temperature</span>
            <span class="n">T_new</span> <span class="o">=</span> <span class="n">T_old</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">K_shelf</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_shelf</span> <span class="o">-</span> <span class="n">T_old</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">cp_solution</span> <span class="o">*</span> <span class="n">mass</span>
            <span class="p">)</span>
            <span class="c1"># saving results</span>
            <span class="n">T_product_cooling</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_new</span>
            <span class="n">time_cooling</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span>
            <span class="c1"># update temperature</span>
            <span class="n">T_old</span> <span class="o">=</span> <span class="n">T_new</span>
            <span class="c1"># check if nucleation occurs stochastically</span>
            <span class="n">J</span> <span class="o">=</span> <span class="n">kb</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_eq_l</span> <span class="o">-</span> <span class="n">T_new</span><span class="p">)</span> <span class="o">**</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_eq_l</span> <span class="o">-</span> <span class="n">T_new</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># frequency of nucleation events</span>
            <span class="n">K_v</span> <span class="o">=</span> <span class="n">J</span> <span class="o">*</span> <span class="n">V</span>
            <span class="c1"># expected number of nuclei</span>
            <span class="n">E_t</span> <span class="o">+=</span> <span class="n">K_v</span> <span class="o">*</span> <span class="n">dt</span>
            <span class="c1"># CDF of probability</span>
            <span class="n">F_nuc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">E_t</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opcond</span><span class="o">.</span><span class="n">cnTemp</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Monte-Carlo approach</span>
                <span class="k">if</span> <span class="n">F_nuc</span> <span class="o">&gt;</span> <span class="n">F_rand</span><span class="p">:</span>
                    <span class="n">Nt_cool_end</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># controlled nucleation</span>
                <span class="k">if</span> <span class="n">T_new</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opcond</span><span class="o">.</span><span class="n">cnTemp</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">):</span>
                    <span class="n">Nt_cool_end</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="k">break</span>

        <span class="c1"># check if nucleation occured</span>
        <span class="k">if</span> <span class="n">Nt_cool_end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nucleation did not occur, prolong process time.&quot;</span><span class="p">)</span>

        <span class="c1"># final solution arrays for cooling stage</span>
        <span class="n">T_product_cooling</span> <span class="o">=</span> <span class="n">T_product_cooling</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nt_cool_end</span><span class="p">]</span>
        <span class="n">T_shelf_cooling</span> <span class="o">=</span> <span class="n">T_shelf_cool</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nt_cool_end</span><span class="p">]</span>
        <span class="n">time_cooling</span> <span class="o">=</span> <span class="n">time_cooling</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">Nt_cool_end</span><span class="p">]</span>

        <span class="c1"># mass fraction of ice over time</span>
        <span class="n">w_i_cooling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T_shelf_cooling</span><span class="p">))</span>

        <span class="c1"># 2. Nucleation phase</span>
        <span class="n">t_nuc</span> <span class="o">=</span> <span class="n">Nt_cool_end</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">T_nuc</span> <span class="o">=</span> <span class="n">T_new</span>

        <span class="c1"># save nucleation results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;T_nuc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_nuc</span> <span class="o">-</span> <span class="mf">273.15</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_nuc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_nuc</span> <span class="o">/</span> <span class="mi">60</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_sol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># solving the quadratic equation</span>
        <span class="n">B</span> <span class="o">=</span> <span class="o">-</span><span class="n">T_m</span> <span class="o">-</span> <span class="n">T_nuc</span> <span class="o">-</span> <span class="n">Dh</span> <span class="o">*</span> <span class="n">mass_water</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_solution</span> <span class="o">*</span> <span class="n">mass</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Dh</span> <span class="o">*</span> <span class="n">mass_water</span> <span class="o">*</span> <span class="n">T_m</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_solution</span> <span class="o">*</span> <span class="n">mass</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">mass_solute</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_f</span> <span class="o">/</span> <span class="n">M_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dh</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_solution</span> <span class="o">*</span> <span class="n">mass</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">T_m</span> <span class="o">*</span> <span class="n">T_nuc</span>
        <span class="p">)</span>

        <span class="c1"># equilibrium temperatures determined from quadratic equation (A = 1)</span>
        <span class="n">T_eq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">B</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">C</span><span class="p">))</span>

        <span class="c1"># computed mass of ice from the quadratic equation</span>
        <span class="n">m_i_eq</span> <span class="o">=</span> <span class="n">mass_water</span> <span class="o">-</span> <span class="n">mass_solute</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_f</span> <span class="o">/</span> <span class="n">M_s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">T_m</span> <span class="o">-</span> <span class="n">T_eq</span><span class="p">)</span>

        <span class="c1"># solution of ice nucleation stage</span>
        <span class="n">w_i_nucl</span> <span class="o">=</span> <span class="n">m_i_eq</span> <span class="o">/</span> <span class="n">mass</span>

        <span class="c1"># preallocation</span>
        <span class="n">T_product_solid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T_shelf_cool</span><span class="p">[</span><span class="n">Nt_cool_end</span><span class="p">:]))</span>
        <span class="n">w_i_solid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T_shelf_cool</span><span class="p">[</span><span class="n">Nt_cool_end</span><span class="p">:]))</span>
        <span class="n">time_solid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">T_shelf_cool</span><span class="p">[</span><span class="n">Nt_cool_end</span><span class="p">:]))</span>

        <span class="c1"># saving results of the ice nucleation stage</span>
        <span class="n">w_i_solid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">w_i_nucl</span>
        <span class="n">T_product_solid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_eq</span>

        <span class="c1"># shelf temperatures</span>
        <span class="n">T_old</span> <span class="o">=</span> <span class="n">T_eq</span>
        <span class="n">w_i_new</span> <span class="o">=</span> <span class="n">w_i_nucl</span>

        <span class="c1"># solidification stage</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">T_shelf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">T_shelf_cool</span><span class="p">[</span><span class="n">Nt_cool_end</span><span class="p">:]):</span>
            <span class="c1"># thermal properties</span>
            <span class="n">cp</span> <span class="o">=</span> <span class="n">cp_s</span> <span class="o">*</span> <span class="n">w_s</span> <span class="o">+</span> <span class="n">cp_i</span> <span class="o">*</span> <span class="n">w_i_new</span> <span class="o">+</span> <span class="n">cp_w</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w_s</span> <span class="o">-</span> <span class="n">w_i_new</span><span class="p">)</span>  <span class="c1"># [J/kgK]</span>
            <span class="c1"># temperature computation</span>
            <span class="n">T_new</span> <span class="o">=</span> <span class="n">T_old</span> <span class="o">+</span> <span class="p">(</span>
                <span class="n">dt</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">K_shelf</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_shelf</span> <span class="o">-</span> <span class="n">T_old</span><span class="p">))</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">cp</span> <span class="o">*</span> <span class="n">rho_l</span> <span class="o">*</span> <span class="n">V</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">Dh</span> <span class="o">*</span> <span class="n">k_f</span> <span class="o">*</span> <span class="n">mass_solute</span> <span class="o">/</span> <span class="n">M_s</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">T_m</span> <span class="o">-</span> <span class="n">T_old</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">**</span> <span class="o">-</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="c1"># update temperatures</span>
            <span class="n">T_old</span> <span class="o">=</span> <span class="n">T_new</span>
            <span class="c1"># save results</span>
            <span class="n">T_product_solid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_new</span>
            <span class="n">time_solid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_nuc</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span>
            <span class="c1"># new ice mass fraction</span>
            <span class="n">w_i_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">mass_water</span> <span class="o">-</span> <span class="p">(</span><span class="n">k_f</span> <span class="o">*</span> <span class="n">mass_solute</span> <span class="o">/</span> <span class="n">M_s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">T_m</span> <span class="o">-</span> <span class="n">T_new</span><span class="p">))</span> <span class="o">/</span> <span class="n">mass</span>
            <span class="c1"># solidification sigma</span>
            <span class="n">sigma_new</span> <span class="o">=</span> <span class="n">w_i_new</span> <span class="o">*</span> <span class="n">mass</span> <span class="o">/</span> <span class="p">(</span><span class="n">mass</span> <span class="o">-</span> <span class="n">mass_solute</span><span class="p">)</span>
            <span class="c1"># save solidification time</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_sol&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sigma_new</span> <span class="o">&gt;=</span> <span class="mf">0.9</span><span class="p">):</span>
                <span class="n">Nt_sol_end</span> <span class="o">=</span> <span class="n">i</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_sol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">60</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_nuc</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span>

        <span class="c1"># check if solidification is completed</span>
        <span class="k">if</span> <span class="n">Nt_sol_end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Solidification is not completed, prolong process time.&quot;</span><span class="p">)</span>

        <span class="c1"># ice mass fraction evolution</span>
        <span class="n">w_i_solid</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mass_water</span> <span class="o">-</span> <span class="p">(</span><span class="n">k_f</span> <span class="o">*</span> <span class="n">mass_solute</span> <span class="o">/</span> <span class="n">M_s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">T_m</span> <span class="o">-</span> <span class="n">T_product_solid</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">mass</span>

        <span class="c1"># time</span>
        <span class="n">time_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">time_cooling</span><span class="p">,</span> <span class="n">time_solid</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span>

        <span class="c1"># temperatures</span>
        <span class="n">temp_results</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">T_product_cooling</span><span class="p">,</span> <span class="n">T_product_solid</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span>
        <span class="p">)</span>
        <span class="n">shelf_results</span> <span class="o">=</span> <span class="n">T_shelf_cool</span> <span class="o">-</span> <span class="mf">273.15</span>

        <span class="c1"># ice mass fraction</span>
        <span class="n">ice_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">w_i_cooling</span><span class="p">,</span> <span class="n">w_i_solid</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># save results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_domain</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span> <span class="o">=</span> <span class="p">(</span><span class="n">T_eq_l</span><span class="p">,</span> <span class="n">w_s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="n">time_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shelfTemp</span> <span class="o">=</span> <span class="n">shelf_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp</span> <span class="o">=</span> <span class="n">temp_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iceMassFraction</span> <span class="o">=</span> <span class="n">ice_results</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;T_nuc&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_nuc&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_sol&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">],</span>
        <span class="p">]</span>

    <span class="c1"># -------------------------------------------------------------------------- #</span>
    <span class="c1"># 1D implementation of the freezing model</span>
    <span class="c1"># -------------------------------------------------------------------------- #</span>

    <span class="c1"># spatial model in 1 dimension</span>
    <span class="k">def</span> <span class="nf">_run_1D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># write into local vars for convenience: geometry</span>
        <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">]</span>

        <span class="c1"># density</span>
        <span class="n">rho_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;rho_l&quot;</span><span class="p">]</span>

        <span class="c1"># mass of individual components</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span>
        <span class="n">mass_water</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;mass_water&quot;</span><span class="p">]</span>
        <span class="n">mass_solute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;mass_solute&quot;</span><span class="p">]</span>
        <span class="n">w_s</span> <span class="o">=</span> <span class="n">mass_solute</span> <span class="o">/</span> <span class="n">mass</span>

        <span class="c1"># heat conductivities</span>
        <span class="n">lambda_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;lambda_w&quot;</span><span class="p">]</span>
        <span class="n">lambda_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;lambda_i&quot;</span><span class="p">]</span>
        <span class="n">lambda_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;lambda_s&quot;</span><span class="p">]</span>

        <span class="c1"># specific heat capacities</span>
        <span class="n">cp_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;cp_w&quot;</span><span class="p">]</span>
        <span class="n">cp_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;cp_i&quot;</span><span class="p">]</span>
        <span class="n">cp_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;cp_s&quot;</span><span class="p">]</span>
        <span class="n">cp_solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;cp_solution&quot;</span><span class="p">]</span>

        <span class="c1"># soluton concentration and freezing-point depression</span>
        <span class="n">solid_fraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;solid_fraction&quot;</span><span class="p">]</span>
        <span class="n">T_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;T_eq&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">273.15</span>
        <span class="n">k_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;k_f&quot;</span><span class="p">]</span>
        <span class="n">M_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;M_s&quot;</span><span class="p">]</span>
        <span class="n">depression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;depression&quot;</span><span class="p">]</span>
        <span class="n">T_eq_l</span> <span class="o">=</span> <span class="n">T_m</span> <span class="o">-</span> <span class="n">depression</span>

        <span class="c1"># nucleation kinetics</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;kb&quot;</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span>

        <span class="c1"># general</span>
        <span class="n">k_B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;k_B&quot;</span><span class="p">]</span>

        <span class="c1"># latent heat of fusion</span>
        <span class="n">Dh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;Dh&quot;</span><span class="p">]</span>

        <span class="c1"># heat transfer coefficient shelf</span>
        <span class="n">K_shelf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="s2">&quot;s0&quot;</span><span class="p">]</span>

        <span class="c1"># additional VISF parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;configuration&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;VISF&quot;</span><span class="p">:</span>
            <span class="c1"># vacuum pressure</span>
            <span class="n">p_vac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;p_vac&quot;</span><span class="p">]</span>
            <span class="c1"># evaporation coefficient</span>
            <span class="n">kappa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;kappa&quot;</span><span class="p">]</span>
            <span class="c1"># latent heat of vaporization for water [J/kg]</span>
            <span class="n">dHe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;Dh_evaporation&quot;</span><span class="p">]</span>
            <span class="c1"># mass of water molecule [kg]</span>
            <span class="n">m_water</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;m_water&quot;</span><span class="p">]</span>
            <span class="c1"># time for vacuum start [h]</span>
            <span class="n">t_vac_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;t_vac_start&quot;</span><span class="p">]</span>
            <span class="c1"># duration of the vacuum [h]</span>
            <span class="n">t_vac_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;t_vac_duration&quot;</span><span class="p">]</span>

        <span class="c1"># [W/mK] effective heat conductivity</span>
        <span class="n">lambda_eff</span> <span class="o">=</span> <span class="n">solid_fraction</span> <span class="o">*</span> <span class="n">lambda_s</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">solid_fraction</span><span class="p">)</span> <span class="o">*</span> <span class="n">lambda_w</span>
        <span class="c1"># heat diffusivity</span>
        <span class="n">diffusivity_cooling</span> <span class="o">=</span> <span class="n">lambda_eff</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_solution</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">)</span>

        <span class="n">Nz</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># [/] number of spatial grid points</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="n">Nz</span>  <span class="c1"># [m] size of spatial step</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">Nz</span><span class="p">)</span>  <span class="c1"># [m] z-position array</span>

        <span class="c1"># limiting value of alpha for computing dt from CFL condition</span>
        <span class="n">alpha_max</span> <span class="o">=</span> <span class="n">lambda_i</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_i</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">)</span>

        <span class="c1"># temporal discretization</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">0.4</span> <span class="o">*</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">alpha_max</span>
        <span class="p">)</span>  <span class="c1"># [s] size of time step (determined by the CFL cond.)</span>

        <span class="n">Nt_exp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opcond</span><span class="o">.</span><span class="n">t_tot</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>  <span class="c1"># the total number of timesteps</span>

        <span class="c1"># Preallocation of arrays for saving results from the cooling stage.</span>
        <span class="n">N_save_cool</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="n">cooling_temp_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_save_cool</span><span class="p">,</span> <span class="n">Nz</span><span class="p">))</span>
        <span class="n">cooling_ice_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_save_cool</span><span class="p">,</span> <span class="n">Nz</span><span class="p">))</span>
        <span class="n">cooling_shelf_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_save_cool</span><span class="p">)</span>
        <span class="n">cooling_time_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_save_cool</span><span class="p">)</span>
        <span class="n">i_save</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># initial temperature</span>
        <span class="n">T_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opcond</span><span class="o">.</span><span class="n">cooling</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">273.15</span>
        <span class="n">T_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nz</span><span class="p">)</span> <span class="o">+</span> <span class="n">T_0</span>  <span class="c1"># [K] temperature profile at t = T_old</span>

        <span class="c1"># shelf temperature and coooling rate</span>
        <span class="n">T_shelf_cool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opcond</span><span class="o">.</span><span class="n">tempProfile</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="mf">273.15</span>

        <span class="c1"># random numbers</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">F_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>

        <span class="c1"># preallocate the expected number of nuclei</span>
        <span class="n">E_t</span><span class="p">,</span> <span class="n">Nt_cool_end</span><span class="p">,</span> <span class="n">Nt_sol_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">T_shelf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">T_shelf_cool</span><span class="p">):</span>
            <span class="c1"># overall heat flux</span>
            <span class="n">q_overall</span> <span class="o">=</span> <span class="n">K_shelf</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_shelf</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># boundary condition on the bottom of the vial: ghost grid point</span>
            <span class="n">T_bottom_BC</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">q_overall</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">lambda_eff</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;configuration&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;VISF&quot;</span><span class="p">:</span>
                <span class="c1"># temperature at the top of the liquid</span>
                <span class="n">T_l</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># vapour temperature</span>
                <span class="n">T_v</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># vapour pressure</span>
                <span class="n">p_vap</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">vapour_pressure_liquid</span><span class="p">(</span><span class="n">T_l</span><span class="p">)</span>

                <span class="c1"># evaporative heat flux (only in the span of vacuum, hold_2)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">t_vac_start</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">t_vac_start</span> <span class="o">+</span> <span class="n">t_vac_duration</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>
                <span class="p">):</span>
                    <span class="c1"># vapour flux</span>
                    <span class="n">N_w</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">vapour_flux</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">m_water</span><span class="p">,</span> <span class="n">k_B</span><span class="p">,</span> <span class="n">p_vac</span><span class="p">,</span> <span class="n">p_vap</span><span class="p">,</span> <span class="n">T_l</span><span class="p">,</span> <span class="n">T_v</span><span class="p">)</span>
                    <span class="c1"># evaporative heat flux</span>
                    <span class="n">q_e</span> <span class="o">=</span> <span class="o">-</span><span class="n">N_w</span> <span class="o">*</span> <span class="n">dHe</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">q_e</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">q_e</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># boundary condition in the top of the vial</span>
            <span class="n">T_top_BC</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q_e</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">lambda_eff</span>

            <span class="c1"># updating the temperature at the bottom</span>
            <span class="n">T_bottom</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">diffusivity_cooling</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_bottom_BC</span>
            <span class="p">)</span>

            <span class="c1"># updating the bulk temperatures</span>
            <span class="n">T_center</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">diffusivity_cooling</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">T_k</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Top point.</span>
            <span class="c1"># updating the top temperature</span>
            <span class="n">T_top</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">diffusivity_cooling</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">T_top_BC</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># update temperatures</span>
            <span class="n">T_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">T_bottom</span><span class="p">,</span> <span class="n">T_center</span><span class="p">,</span> <span class="n">T_top</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="c1"># nucleation rate (global aproach)</span>
            <span class="n">superCooledMask</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">&lt;</span> <span class="n">T_eq_l</span>
            <span class="n">J_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">J_z</span><span class="p">[</span><span class="n">superCooledMask</span><span class="p">]</span> <span class="o">=</span> <span class="n">kb</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_eq_l</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="n">superCooledMask</span><span class="p">])</span> <span class="o">**</span> <span class="n">b</span>

            <span class="c1"># compute the frequency of nucleation</span>
            <span class="n">K_v</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">simps</span><span class="p">(</span><span class="n">J_z</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

            <span class="c1"># check the range of LCS = LocalSupercooling</span>
            <span class="n">LCS_i</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">&lt;</span> <span class="n">T_eq_l</span>
            <span class="c1"># the not so supercool part</span>
            <span class="n">LCS_i_r</span> <span class="o">=</span> <span class="o">~</span><span class="n">LCS_i</span>

            <span class="c1"># sparsely saving results</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">Nt_exp</span> <span class="o">/</span> <span class="n">N_save_cool</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># saving temperature results</span>
                <span class="n">cooling_temp_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">-</span> <span class="mf">273.15</span>
                <span class="c1"># saving shelf temperature results</span>
                <span class="n">cooling_shelf_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_shelf</span> <span class="o">-</span> <span class="mf">273.15</span>
                <span class="c1"># ice</span>
                <span class="n">cooling_ice_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">T_k</span>
                <span class="c1"># saving sparse time array</span>
                <span class="n">cooling_time_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span>
                <span class="c1"># update saving index</span>
                <span class="n">i_save</span> <span class="o">=</span> <span class="n">i_save</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># expected number of nuclei</span>
            <span class="n">E_t</span> <span class="o">+=</span> <span class="n">K_v</span> <span class="o">*</span> <span class="n">dt</span>
            <span class="c1"># CDF of probability</span>
            <span class="n">F_nuc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">E_t</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opcond</span><span class="o">.</span><span class="n">cnTemp</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Monte-Carlo approach</span>
                <span class="k">if</span> <span class="n">F_nuc</span> <span class="o">&gt;</span> <span class="n">F_rand</span><span class="p">:</span>
                    <span class="n">Nt_cool_end</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">t_nuc</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span>
                    <span class="n">T_nuc</span> <span class="o">=</span> <span class="n">T_k</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># controlled nucleation</span>
                <span class="k">if</span> <span class="n">T_k</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opcond</span><span class="o">.</span><span class="n">cnTemp</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">):</span>
                    <span class="n">Nt_cool_end</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">t_nuc</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span>
                    <span class="n">T_nuc</span> <span class="o">=</span> <span class="n">T_k</span>
                    <span class="k">break</span>

        <span class="c1"># check if nucleation occured</span>
        <span class="k">if</span> <span class="n">Nt_cool_end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nucleation did not occur, prolong process time.&quot;</span><span class="p">)</span>

        <span class="c1"># kinetic mean nucleation temperature</span>
        <span class="n">T_nuc_kin</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">/</span> <span class="n">K_v</span><span class="p">)</span> <span class="o">*</span> <span class="n">simps</span><span class="p">(</span><span class="n">T_nuc</span> <span class="o">*</span> <span class="n">J_z</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

        <span class="c1"># save nucleation temperatures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;T_nuc_min&quot;</span><span class="p">:</span> <span class="n">T_nuc</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">,</span>
            <span class="s2">&quot;T_nuc_kin&quot;</span><span class="p">:</span> <span class="n">T_nuc_kin</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">,</span>
            <span class="s2">&quot;T_nuc_mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">T_nuc</span><span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">,</span>
            <span class="s2">&quot;T_nuc_max&quot;</span><span class="p">:</span> <span class="n">T_nuc</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># save nucleation time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_nuc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_nuc</span> <span class="o">/</span> <span class="mi">60</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_sol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="s2">&quot; 2. Ice nucleation stage. &quot;</span>

        <span class="c1"># solving the quadratic equation (vectorized (A = 1)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="o">-</span><span class="n">T_m</span> <span class="o">-</span> <span class="n">T_nuc</span> <span class="o">-</span> <span class="n">Dh</span> <span class="o">*</span> <span class="n">mass_water</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_solution</span> <span class="o">*</span> <span class="n">mass</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Dh</span> <span class="o">*</span> <span class="n">mass_water</span> <span class="o">*</span> <span class="n">T_m</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_solution</span> <span class="o">*</span> <span class="n">mass</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">mass_solute</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_f</span> <span class="o">/</span> <span class="n">M_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dh</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_solution</span> <span class="o">*</span> <span class="n">mass</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">T_m</span> <span class="o">*</span> <span class="n">T_nuc</span>
        <span class="p">)</span>

        <span class="c1"># lcoal supercooling</span>
        <span class="n">LCS_i</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">&lt;</span> <span class="n">T_eq_l</span>
        <span class="c1"># the not so supercool part</span>
        <span class="n">LCS_i_r</span> <span class="o">=</span> <span class="o">~</span><span class="n">LCS_i</span>

        <span class="c1"># equilibrium temperatures determined from quadratic equation (A = 1)</span>
        <span class="n">T_eq_sol_1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">B</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">C</span><span class="p">))</span>

        <span class="c1"># temperaure field after nucleation</span>
        <span class="n">T_after_nuc</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">*</span> <span class="n">LCS_i_r</span> <span class="o">+</span> <span class="n">T_eq_sol_1</span> <span class="o">*</span> <span class="n">LCS_i</span>

        <span class="c1"># computed mass of ice from the quadratic equation (T_k used just to get</span>
        <span class="c1"># the same dimensions)</span>
        <span class="n">m_i_nucl_sol_1</span> <span class="o">=</span> <span class="n">mass_water</span> <span class="o">-</span> <span class="n">mass_solute</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_f</span> <span class="o">/</span> <span class="n">M_s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">T_m</span> <span class="o">-</span> <span class="n">T_eq_sol_1</span><span class="p">)</span>
        <span class="n">m_i_eq</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">T_k</span> <span class="o">*</span> <span class="n">LCS_i_r</span> <span class="o">+</span> <span class="n">m_i_nucl_sol_1</span> <span class="o">*</span> <span class="n">LCS_i</span>

        <span class="c1"># save temperature profile after nucleation</span>
        <span class="n">cooling_temp_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T_after_nuc</span> <span class="o">-</span> <span class="mf">273.15</span>
        <span class="c1"># saving shelf temperature results</span>
        <span class="n">cooling_shelf_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_shelf</span> <span class="o">-</span> <span class="mf">273.15</span>
        <span class="c1"># ice</span>
        <span class="n">cooling_ice_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_i_eq</span> <span class="o">/</span> <span class="p">(</span><span class="n">mass_water</span> <span class="o">+</span> <span class="n">mass_solute</span><span class="p">)</span>
        <span class="c1"># saving sparse time array</span>
        <span class="n">cooling_time_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span>

        <span class="n">i_end</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">i_save_end</span> <span class="o">=</span> <span class="n">i_save</span>

        <span class="s2">&quot; 3. Solidification stage. &quot;</span>

        <span class="n">N_save_solid</span> <span class="o">=</span> <span class="mi">10000</span>

        <span class="c1"># arrays of temperature</span>
        <span class="n">T_k</span> <span class="o">=</span> <span class="n">T_after_nuc</span>  <span class="c1"># [K] temperature profile at t = T_old</span>

        <span class="c1"># array of ice mass fractions</span>
        <span class="n">w_i_k</span> <span class="o">=</span> <span class="n">m_i_eq</span> <span class="o">/</span> <span class="p">(</span><span class="n">mass_water</span> <span class="o">+</span> <span class="n">mass_solute</span><span class="p">)</span>
        <span class="n">Nt_solid</span> <span class="o">=</span> <span class="n">Nt_exp</span> <span class="o">-</span> <span class="n">i_end</span>

        <span class="c1"># Preallocation of arrays for saving results from the cooling stage.</span>
        <span class="n">solid_temp_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_save_solid</span><span class="p">,</span> <span class="n">Nz</span><span class="p">))</span>
        <span class="n">solid_ice_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_save_solid</span><span class="p">,</span> <span class="n">Nz</span><span class="p">))</span>
        <span class="n">solid_shelf_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_save_solid</span><span class="p">)</span>
        <span class="n">solid_time_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_save_solid</span><span class="p">)</span>
        <span class="n">i_save</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># FDM scheme for solving the heat conduction equation</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">T_shelf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">T_shelf_cool</span><span class="p">[</span><span class="n">i_end</span><span class="p">:]):</span>
            <span class="c1"># local supercooling</span>
            <span class="n">LCS_i</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">&lt;</span> <span class="n">T_eq_l</span>
            <span class="c1"># the not so supercool part</span>
            <span class="n">LCS_i_r</span> <span class="o">=</span> <span class="o">~</span><span class="n">LCS_i</span>

            <span class="s2">&quot; Thermal properties. &quot;</span>
            <span class="c1"># heat capacity</span>
            <span class="n">cp_solution</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">cp_s</span> <span class="o">*</span> <span class="n">solid_fraction</span>
                <span class="o">+</span> <span class="n">cp_i</span> <span class="o">*</span> <span class="n">w_i_k</span>
                <span class="o">+</span> <span class="n">cp_w</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">solid_fraction</span> <span class="o">-</span> <span class="n">w_i_k</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># heat conductivity</span>
            <span class="n">lambda_eff</span> <span class="o">=</span> <span class="n">lambda_i</span> <span class="o">*</span> <span class="n">w_i_k</span> <span class="o">+</span> <span class="n">lambda_w</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w_i_k</span><span class="p">)</span>
            <span class="c1"># nonlinear capacitance term</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">Dh</span> <span class="o">*</span> <span class="n">k_f</span> <span class="o">*</span> <span class="n">mass_solute</span> <span class="o">/</span> <span class="p">(</span><span class="n">M_s</span> <span class="o">*</span> <span class="n">rho_l</span> <span class="o">*</span> <span class="n">V</span> <span class="o">*</span> <span class="n">cp_solution</span><span class="p">)</span>
            <span class="c1"># total nonlinear capacitance term</span>
            <span class="n">BETA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Nz</span><span class="p">)</span> <span class="o">*</span> <span class="n">LCS_i_r</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">/</span> <span class="p">(</span><span class="n">T_k</span> <span class="o">-</span> <span class="n">T_m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">LCS_i</span>

            <span class="s2">&quot; Boundary condition at the bottom, z = 0.&quot;</span>
            <span class="c1"># overall heat flux</span>
            <span class="n">q_overall</span> <span class="o">=</span> <span class="n">K_shelf</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_shelf</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># boundary condition on the bottom of the vial: ghost grid point</span>
            <span class="n">T_bottom_BC</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">q_overall</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">lambda_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;configuration&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;VISF&quot;</span><span class="p">:</span>
                <span class="c1"># temperature at the top of the liquid</span>
                <span class="n">T_l</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># vapour temperature</span>
                <span class="n">T_v</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># vapour pressure</span>
                <span class="n">p_vap</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">vapour_pressure_solid</span><span class="p">(</span><span class="n">T_l</span><span class="p">)</span>

                <span class="c1"># evaporative heat flux (only in the span of vacuum, hold_2)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">t_nuc</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">t_vac_start</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">t_nuc</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">t_vac_start</span> <span class="o">+</span> <span class="n">t_vac_duration</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>
                <span class="p">):</span>
                    <span class="c1"># vapour flux</span>
                    <span class="n">N_w</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">vapour_flux</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">m_water</span><span class="p">,</span> <span class="n">k_B</span><span class="p">,</span> <span class="n">p_vac</span><span class="p">,</span> <span class="n">p_vap</span><span class="p">,</span> <span class="n">T_l</span><span class="p">,</span> <span class="n">T_v</span><span class="p">)</span>
                    <span class="c1"># evaporative heat flux</span>
                    <span class="n">q_e</span> <span class="o">=</span> <span class="o">-</span><span class="n">N_w</span> <span class="o">*</span> <span class="n">dHe</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">q_e</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">q_e</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="s2">&quot; Boundary condition at the top, z = height.&quot;</span>
            <span class="c1"># boundary condition in the top of the vial</span>
            <span class="n">T_top_BC</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q_e</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">lambda_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="s2">&quot; Bottom point. &quot;</span>
            <span class="c1"># update the point at the bottom</span>
            <span class="n">T_bottom</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_solution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">lambda_eff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lambda_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_bottom_BC</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">lambda_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_bottom_BC</span><span class="p">)</span> <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">BETA</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="s2">&quot; Center points. &quot;</span>
            <span class="c1"># update the bulk points</span>
            <span class="n">T_center</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_solution</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">lambda_eff</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">]</span> <span class="o">-</span> <span class="n">lambda_eff</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">lambda_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">BETA</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="s2">&quot; Top point. &quot;</span>
            <span class="c1"># update the temperature at the top</span>
            <span class="n">T_top</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_solution</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">lambda_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lambda_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_top_BC</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">lambda_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_top_BC</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">BETA</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="s2">&quot; Processing the results I: temperatures. &quot;</span>
            <span class="c1"># update temperatures</span>
            <span class="n">T_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">T_bottom</span><span class="p">,</span> <span class="n">T_center</span><span class="p">,</span> <span class="n">T_top</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="s2">&quot; Check for local supercooling. &quot;</span>
            <span class="c1"># check the range of LCS</span>
            <span class="n">LCS_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">T_k</span> <span class="o">&lt;</span> <span class="n">T_eq_l</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># the not so supercool region</span>
            <span class="n">LCS_i_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">LCS_i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="s2">&quot; Processing the results II: ice mass fractions. &quot;</span>
            <span class="c1"># ice mass distribution</span>
            <span class="n">m_ice</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nz</span><span class="p">)</span> <span class="o">*</span> <span class="n">LCS_i_r</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">mass_water</span> <span class="o">-</span> <span class="n">mass_solute</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_f</span> <span class="o">/</span> <span class="n">M_s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">T_m</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">))</span> <span class="o">*</span> <span class="n">LCS_i</span>
            <span class="p">)</span>
            <span class="c1"># ice mass fraction distribution</span>
            <span class="n">w_i_k</span> <span class="o">=</span> <span class="n">m_ice</span> <span class="o">/</span> <span class="n">mass</span>

            <span class="s2">&quot; Saving results of the cooling stage. &quot;</span>
            <span class="c1"># sparse saving</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">Nt_solid</span> <span class="o">/</span> <span class="n">N_save_solid</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># temperature results</span>
                <span class="n">solid_temp_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">-</span> <span class="mf">273.15</span>
                <span class="c1"># ice mass fraction results</span>
                <span class="n">solid_ice_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">w_i_k</span>
                <span class="c1"># shelf temperature results</span>
                <span class="n">solid_shelf_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_shelf</span> <span class="o">-</span> <span class="mf">273.15</span>
                <span class="c1"># saving sparse time array</span>
                <span class="n">solid_time_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_nuc</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span>
                <span class="c1"># updating saving index</span>
                <span class="n">i_save</span> <span class="o">=</span> <span class="n">i_save</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># solidification sigma</span>
            <span class="n">sigma_new</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">simps</span><span class="p">(</span><span class="n">m_ice</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mass</span> <span class="o">-</span> <span class="n">mass_solute</span><span class="p">)</span>
            <span class="c1"># save solidification time</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_sol&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sigma_new</span> <span class="o">&gt;=</span> <span class="mf">0.9</span><span class="p">):</span>
                <span class="n">Nt_sol_end</span> <span class="o">=</span> <span class="n">i</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_sol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">60</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_nuc</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span>

        <span class="c1"># check if solidification is completed</span>
        <span class="k">if</span> <span class="n">Nt_sol_end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Solidification is not completed, prolong process time.&quot;</span><span class="p">)</span>

        <span class="c1"># temperature distributions in the product</span>
        <span class="n">temp_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">cooling_temp_results</span><span class="p">[:</span> <span class="n">i_save_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                <span class="n">solid_temp_results</span><span class="p">[:</span> <span class="n">i_save</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">),</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># ice mass fraction results</span>
        <span class="n">ice_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">cooling_ice_results</span><span class="p">[:</span> <span class="n">i_save_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                <span class="n">solid_ice_results</span><span class="p">[:</span> <span class="n">i_save</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">),</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># total time array</span>
        <span class="n">time_results</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">cooling_time_results</span><span class="p">[:</span> <span class="n">i_save_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">solid_time_results</span><span class="p">[:</span> <span class="n">i_save</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="p">),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="mi">3600</span>
        <span class="p">)</span>

        <span class="c1"># total shelf temperature array</span>
        <span class="n">shelf_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">cooling_shelf_results</span><span class="p">[:</span> <span class="n">i_save_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">solid_shelf_results</span><span class="p">[:</span> <span class="n">i_save</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># save results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_domain</span> <span class="o">=</span> <span class="n">z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nuc</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_nuc</span><span class="p">,</span> <span class="n">T_nuc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span> <span class="o">=</span> <span class="p">(</span><span class="n">T_eq_l</span><span class="p">,</span> <span class="n">w_s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="n">time_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shelfTemp</span> <span class="o">=</span> <span class="n">shelf_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp</span> <span class="o">=</span> <span class="n">temp_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iceMassFraction</span> <span class="o">=</span> <span class="n">ice_results</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;T_nuc_min&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;T_nuc_kin&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;T_nuc_mean&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;T_nuc_max&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_nuc&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_sol&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">],</span>
        <span class="p">]</span>

    <span class="c1"># -------------------------------------------------------------------------- #</span>
    <span class="c1"># 2D implementation of the freezing model</span>
    <span class="c1"># -------------------------------------------------------------------------- #</span>

    <span class="c1"># spatial model in 2 dimensions</span>
    <span class="k">def</span> <span class="nf">_run_2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># write into local vars for convenience: geometry</span>
        <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
        <span class="n">diameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;diameter&quot;</span><span class="p">]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">]</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">diameter</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># density</span>
        <span class="n">rho_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;rho_l&quot;</span><span class="p">]</span>

        <span class="c1"># mass of individual components</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span>
        <span class="n">mass_water</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;mass_water&quot;</span><span class="p">]</span>
        <span class="n">mass_solute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;mass_solute&quot;</span><span class="p">]</span>
        <span class="n">w_s</span> <span class="o">=</span> <span class="n">mass_solute</span> <span class="o">/</span> <span class="n">mass</span>

        <span class="c1"># heat conductivities</span>
        <span class="n">lambda_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;lambda_w&quot;</span><span class="p">]</span>
        <span class="n">lambda_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;lambda_i&quot;</span><span class="p">]</span>
        <span class="n">lambda_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;lambda_s&quot;</span><span class="p">]</span>

        <span class="c1"># specific heat capacities</span>
        <span class="n">cp_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;cp_w&quot;</span><span class="p">]</span>
        <span class="n">cp_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;cp_i&quot;</span><span class="p">]</span>
        <span class="n">cp_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;cp_s&quot;</span><span class="p">]</span>
        <span class="n">cp_solution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;cp_solution&quot;</span><span class="p">]</span>

        <span class="c1"># soluton concentration and freezing-point depression</span>
        <span class="n">solid_fraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;solid_fraction&quot;</span><span class="p">]</span>
        <span class="n">T_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;T_eq&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">273.15</span>
        <span class="n">k_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;k_f&quot;</span><span class="p">]</span>
        <span class="n">M_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;M_s&quot;</span><span class="p">]</span>
        <span class="n">depression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;depression&quot;</span><span class="p">]</span>
        <span class="n">T_eq_l</span> <span class="o">=</span> <span class="n">T_m</span> <span class="o">-</span> <span class="n">depression</span>

        <span class="c1"># nucleation kinetics</span>
        <span class="n">kb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;kb&quot;</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span>

        <span class="c1"># general</span>
        <span class="n">k_B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;k_B&quot;</span><span class="p">]</span>

        <span class="c1"># latent heat of fusion</span>
        <span class="n">Dh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;Dh&quot;</span><span class="p">]</span>

        <span class="c1"># shelf heat transfer coefficient</span>
        <span class="n">K_shelf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="s2">&quot;s0&quot;</span><span class="p">]</span>

        <span class="c1"># additional VISF parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;configuration&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;VISF&quot;</span><span class="p">:</span>
            <span class="c1"># vacuum pressure</span>
            <span class="n">p_vac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;p_vac&quot;</span><span class="p">]</span>
            <span class="c1"># evaporation coefficient</span>
            <span class="n">kappa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;kappa&quot;</span><span class="p">]</span>
            <span class="c1"># latent heat of vaporization for water [J/kg]</span>
            <span class="n">dHe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;Dh_evaporation&quot;</span><span class="p">]</span>
            <span class="c1"># mass of water molecule [kg]</span>
            <span class="n">m_water</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;m_water&quot;</span><span class="p">]</span>
            <span class="c1"># time for vacuum start [h]</span>
            <span class="n">t_vac_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;t_vac_start&quot;</span><span class="p">]</span>
            <span class="c1"># duration of the vacuum [h]</span>
            <span class="n">t_vac_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;t_vac_duration&quot;</span><span class="p">]</span>

        <span class="c1"># additional jacket-ramped freezing parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;configuration&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;jacket&quot;</span><span class="p">:</span>
            <span class="c1"># vacuum pressure</span>
            <span class="n">air_gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;air_gap&quot;</span><span class="p">]</span>
            <span class="c1"># evaporation coefficient</span>
            <span class="n">lambda_air</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;lambda_air&quot;</span><span class="p">]</span>
            <span class="c1"># compute the wall heat transfer coefficient</span>
            <span class="n">K_wall</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">K_shelf</span> <span class="o">+</span> <span class="n">air_gap</span> <span class="o">/</span> <span class="n">lambda_air</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [W/m2K]</span>

        <span class="c1"># [W/mK] effective heat conductivity</span>
        <span class="n">k_eff</span> <span class="o">=</span> <span class="n">solid_fraction</span> <span class="o">*</span> <span class="n">lambda_s</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">solid_fraction</span><span class="p">)</span> <span class="o">*</span> <span class="n">lambda_w</span>

        <span class="c1"># heat diffusivity</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">k_eff</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_solution</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">)</span>

        <span class="n">Nz</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># [/] number of spatial grid points</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="n">Nz</span>  <span class="c1"># [m] size of spatial step</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">Nz</span><span class="p">)</span>  <span class="c1"># [m] z-position array</span>

        <span class="c1"># spatal discretization in the radial direction</span>
        <span class="n">Nr</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># [/] number of spatial grid</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">/</span> <span class="n">Nr</span>  <span class="c1"># [m] size of spatial step</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">Nr</span><span class="p">)</span>  <span class="c1"># [m] z-position array</span>

        <span class="c1"># limiting value of alpha for computing dt from CFL condition</span>
        <span class="n">alpha_max</span> <span class="o">=</span> <span class="n">lambda_i</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_i</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">)</span>

        <span class="c1"># temporal discretization</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mf">0.4</span> <span class="o">/</span> <span class="n">alpha_max</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">dr</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># [s] size of time step</span>

        <span class="n">Nt_exp</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opcond</span><span class="o">.</span><span class="n">t_tot</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>  <span class="c1"># the total number of timesteps</span>

        <span class="c1"># Preallocation of arrays for saving results from the cooling stage.</span>
        <span class="n">N_save_cool</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="n">cooling_temp_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_save_cool</span><span class="p">,</span> <span class="n">Nz</span><span class="p">,</span> <span class="n">Nr</span><span class="p">))</span>
        <span class="n">cooling_ice_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_save_cool</span><span class="p">,</span> <span class="n">Nz</span><span class="p">,</span> <span class="n">Nr</span><span class="p">))</span>
        <span class="n">cooling_shelf_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_save_cool</span><span class="p">)</span>
        <span class="n">cooling_time_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_save_cool</span><span class="p">)</span>
        <span class="n">i_save</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># initial temperature</span>
        <span class="n">T_0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opcond</span><span class="o">.</span><span class="n">cooling</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">273.15</span>
        <span class="n">T_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nr</span><span class="p">))</span> <span class="o">+</span> <span class="n">T_0</span>  <span class="c1"># [K] temperature profile at t = T_old</span>
        <span class="n">T_new</span> <span class="o">=</span> <span class="n">T_k</span>

        <span class="c1"># shelf temperature and coooling rate</span>
        <span class="n">T_shelf_cool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opcond</span><span class="o">.</span><span class="n">tempProfile</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="mf">273.15</span>

        <span class="c1"># random numbers</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">F_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>

        <span class="c1"># preallocate the expected number of nuclei</span>
        <span class="n">E_t</span><span class="p">,</span> <span class="n">Nt_cool_end</span><span class="p">,</span> <span class="n">Nt_sol_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># finite difference method for solving the heat conduction equation</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">T_shelf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">T_shelf_cool</span><span class="p">):</span>
            <span class="s2">&quot;Boundary condition at the bottom, z = 0.&quot;</span>
            <span class="c1"># overall heat flux</span>
            <span class="n">q_overall</span> <span class="o">=</span> <span class="n">K_shelf</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_shelf</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
            <span class="c1"># boundary condition on the bottom of the vial: ghost grid point</span>
            <span class="n">T_bottom</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">q_overall</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">k_eff</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;configuration&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;VISF&quot;</span><span class="p">:</span>
                <span class="c1"># temperature at the top of the liquid</span>
                <span class="n">T_l</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="c1"># vapour temperature</span>
                <span class="n">T_v</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="c1"># vapour pressure</span>
                <span class="n">p_vap</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">vapour_pressure_solid</span><span class="p">(</span><span class="n">T_l</span><span class="p">)</span>

                <span class="c1"># evaporative heat flux (only in the span of vacuum, hold_2)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">t_vac_start</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">t_vac_start</span> <span class="o">+</span> <span class="n">t_vac_duration</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>
                <span class="p">):</span>
                    <span class="c1"># vapour flux</span>
                    <span class="n">N_w</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">vapour_flux</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">m_water</span><span class="p">,</span> <span class="n">k_B</span><span class="p">,</span> <span class="n">p_vac</span><span class="p">,</span> <span class="n">p_vap</span><span class="p">,</span> <span class="n">T_l</span><span class="p">,</span> <span class="n">T_v</span><span class="p">)</span>
                    <span class="c1"># evaporative heat flux</span>
                    <span class="n">q_e</span> <span class="o">=</span> <span class="o">-</span><span class="n">N_w</span> <span class="o">*</span> <span class="n">dHe</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">q_e</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">q_e</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># boundary condition in the top of the vial</span>
            <span class="n">T_top</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">q_e</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">k_eff</span>

            <span class="s2">&quot; Boundary conditions at the edge, r = R. &quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;configuration&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;jacket&quot;</span><span class="p">:</span>
                <span class="c1"># jacket heat flux</span>
                <span class="n">q_jacket</span> <span class="o">=</span> <span class="n">K_wall</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_shelf</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[:,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no cooling from jacket</span>
                <span class="n">q_jacket</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># boundary condition in the top of the vial</span>
            <span class="n">T_edge</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[:,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q_jacket</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">k_eff</span>

            <span class="s2">&quot; Boundary condition in the centre, r = 0. &quot;</span>
            <span class="c1"># axial symmetry</span>
            <span class="n">T_center</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="s2">&quot; Bottom boundary points: z = 0. &quot;</span>
            <span class="c1"># bottom-centre: r = 0</span>
            <span class="n">T_new</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_bottom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span>

            <span class="c1"># bottom corner (left or right - symmetry): r = R</span>
            <span class="n">T_new</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">T_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_bottom</span><span class="p">[</span><span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span>

            <span class="c1"># the rest of the bottom: 0 &lt; r &lt; R</span>
            <span class="n">T_new</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_bottom</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span>

            <span class="s2">&quot; Top boundary points: z = H. &quot;</span>
            <span class="c1"># top centre: r = 0</span>
            <span class="n">T_new</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_center</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">T_top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span>

            <span class="c1"># top corner (left and right - symmetry): r = R</span>
            <span class="n">T_new</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_edge</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">T_edge</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">T_top</span><span class="p">[</span><span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span>

            <span class="c1"># the rest of the vial&#39;s top: 0 &lt; r &lt; R</span>
            <span class="n">T_new</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span>
                    <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="n">T_top</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span>

            <span class="s2">&quot; Edge boundary points: r = R. &quot;</span>
            <span class="c1"># curved cylinder surface in contact with air: 0 &lt; z &lt; H</span>
            <span class="n">T_new</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_edge</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="n">T_edge</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="n">T_k</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span>

            <span class="s2">&quot; Center boundary points: r = 0. &quot;</span>
            <span class="c1"># symmetry boundary condition in the centre of the cylinder: 0 &lt; z &lt; H</span>
            <span class="n">T_new</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">2</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_center</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span>

            <span class="s2">&quot; Bulk of the vial points: : 0 &lt; z &lt; H &amp; 0 &lt; r &lt; R. &quot;</span>
            <span class="c1"># all the other points in the domain</span>
            <span class="n">T_new</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span>
                    <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="n">T_k</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span>

            <span class="s2">&quot; Processing the results of the time iteration. &quot;</span>
            <span class="c1"># update temperatures</span>
            <span class="n">T_k</span> <span class="o">=</span> <span class="n">T_new</span>

            <span class="c1"># Stochastic nucleation for the entire vial.</span>
            <span class="c1"># nucleation rate (global aproach)</span>
            <span class="n">superCooledMask</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">&lt;</span> <span class="n">T_eq_l</span>
            <span class="n">J_z_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nr</span><span class="p">))</span>
            <span class="n">J_z_r</span><span class="p">[</span><span class="n">superCooledMask</span><span class="p">]</span> <span class="o">=</span> <span class="n">kb</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_eq_l</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="n">superCooledMask</span><span class="p">])</span> <span class="o">**</span> <span class="n">b</span>

            <span class="c1"># frequency of nucleation events itegrated over z</span>
            <span class="n">K_r</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">simps</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">J_z_r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="c1"># frequency of nucleation events itegrated over r</span>
            <span class="n">K_v</span> <span class="o">=</span> <span class="n">simps</span><span class="p">(</span><span class="n">K_r</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

            <span class="c1"># Check for local supercooling.</span>
            <span class="c1"># check the range of LCS = LocalSupercooling</span>
            <span class="n">LCS_i</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">&lt;</span> <span class="n">T_eq_l</span>
            <span class="c1"># the not so supercool part</span>
            <span class="n">LCS_i_r</span> <span class="o">=</span> <span class="o">~</span><span class="n">LCS_i</span>

            <span class="c1"># Saving results of the cooling stage.</span>
            <span class="c1"># sparsely saving results</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">Nt_exp</span> <span class="o">/</span> <span class="n">N_save_cool</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># saving temperature results</span>
                <span class="n">cooling_temp_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">-</span> <span class="mf">273.15</span>
                <span class="c1"># saving shelf temperature results</span>
                <span class="n">cooling_shelf_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_shelf</span> <span class="o">-</span> <span class="mf">273.15</span>
                <span class="c1"># ice</span>
                <span class="n">cooling_ice_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">T_k</span>
                <span class="c1"># saving sparse time array</span>
                <span class="n">cooling_time_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span>
                <span class="c1"># update saving index</span>
                <span class="n">i_save</span> <span class="o">=</span> <span class="n">i_save</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># expected number of nuclei</span>
            <span class="n">E_t</span> <span class="o">+=</span> <span class="n">K_v</span> <span class="o">*</span> <span class="n">dt</span>
            <span class="c1"># CDF of probability</span>
            <span class="n">F_nuc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">E_t</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opcond</span><span class="o">.</span><span class="n">cnTemp</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Monte-Carlo approach</span>
                <span class="k">if</span> <span class="n">F_nuc</span> <span class="o">&gt;</span> <span class="n">F_rand</span><span class="p">:</span>
                    <span class="n">Nt_cool_end</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">t_nuc</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span>
                    <span class="n">T_nuc</span> <span class="o">=</span> <span class="n">T_k</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># controlled nucleation</span>
                <span class="k">if</span> <span class="n">T_k</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opcond</span><span class="o">.</span><span class="n">cnTemp</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">):</span>
                    <span class="n">Nt_cool_end</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">t_nuc</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span>
                    <span class="n">T_nuc</span> <span class="o">=</span> <span class="n">T_k</span>
                    <span class="k">break</span>

        <span class="c1"># check if nucleation occured</span>
        <span class="k">if</span> <span class="n">Nt_cool_end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Nucleation did not occur, prolong process time.&quot;</span><span class="p">)</span>

        <span class="c1"># compute the mean kinetic mean nucleation temperature</span>
        <span class="n">f_z</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">simps</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">T_nuc</span> <span class="o">*</span> <span class="n">J_z_r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">T_nuc_kin</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">K_v</span><span class="p">)</span> <span class="o">*</span> <span class="n">simps</span><span class="p">(</span><span class="n">f_z</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

        <span class="c1"># save nucleation temperatures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;T_nuc_min&quot;</span><span class="p">:</span> <span class="n">T_nuc</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">,</span>
            <span class="s2">&quot;T_nuc_kin&quot;</span><span class="p">:</span> <span class="n">T_nuc_kin</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">,</span>
            <span class="s2">&quot;T_nuc_mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">T_nuc</span><span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">,</span>
            <span class="s2">&quot;T_nuc_max&quot;</span><span class="p">:</span> <span class="n">T_nuc</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># save nucleation time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_nuc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_nuc</span> <span class="o">/</span> <span class="mi">60</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_sol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># solving the quadratic equation (vectorized (A = 1)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="o">-</span><span class="n">T_m</span> <span class="o">-</span> <span class="n">T_nuc</span> <span class="o">-</span> <span class="n">Dh</span> <span class="o">*</span> <span class="n">mass_water</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_solution</span> <span class="o">*</span> <span class="n">mass</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Dh</span> <span class="o">*</span> <span class="n">mass_water</span> <span class="o">*</span> <span class="n">T_m</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_solution</span> <span class="o">*</span> <span class="n">mass</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">mass_solute</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_f</span> <span class="o">/</span> <span class="n">M_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dh</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_solution</span> <span class="o">*</span> <span class="n">mass</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">T_m</span> <span class="o">*</span> <span class="n">T_nuc</span>
        <span class="p">)</span>

        <span class="c1"># lcoal supercooling</span>
        <span class="n">LCS_i</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">&lt;</span> <span class="n">T_eq_l</span>
        <span class="c1"># the not so supercool part</span>
        <span class="n">LCS_i_r</span> <span class="o">=</span> <span class="o">~</span><span class="n">LCS_i</span>

        <span class="c1"># equilibrium temperatures determined from quadratic equation (A = 1)</span>
        <span class="n">T_eq_sol_1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">B</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">B</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">C</span><span class="p">))</span>

        <span class="c1"># temperaure field after nucleation</span>
        <span class="n">T_after_nuc</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">*</span> <span class="n">LCS_i_r</span> <span class="o">+</span> <span class="n">T_eq_sol_1</span> <span class="o">*</span> <span class="n">LCS_i</span>

        <span class="c1"># computed mass of ice from the quadratic equation (T_k used just to get</span>
        <span class="c1"># the same dimensions)</span>
        <span class="n">m_i_nucl_sol_1</span> <span class="o">=</span> <span class="n">mass_water</span> <span class="o">-</span> <span class="n">mass_solute</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_f</span> <span class="o">/</span> <span class="n">M_s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">T_m</span> <span class="o">-</span> <span class="n">T_eq_sol_1</span><span class="p">)</span>
        <span class="n">m_i_eq</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">T_k</span> <span class="o">*</span> <span class="n">LCS_i_r</span> <span class="o">+</span> <span class="n">m_i_nucl_sol_1</span> <span class="o">*</span> <span class="n">LCS_i</span>

        <span class="n">cooling_temp_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T_after_nuc</span> <span class="o">-</span> <span class="mf">273.15</span>
        <span class="c1"># saving shelf temperature results</span>
        <span class="n">cooling_shelf_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_shelf</span> <span class="o">-</span> <span class="mf">273.15</span>
        <span class="c1"># ice</span>
        <span class="n">cooling_ice_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_i_eq</span> <span class="o">/</span> <span class="p">(</span><span class="n">mass_water</span> <span class="o">+</span> <span class="n">mass_solute</span><span class="p">)</span>
        <span class="c1"># saving sparse time array</span>
        <span class="n">cooling_time_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span>
        <span class="n">i_end</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">i_save_end</span> <span class="o">=</span> <span class="n">i_save</span>
        <span class="n">N_save_solid</span> <span class="o">=</span> <span class="mi">10000</span>

        <span class="c1"># arrays of temperature</span>
        <span class="n">T_k</span> <span class="o">=</span> <span class="n">T_after_nuc</span>  <span class="c1"># [K] temperature profile at t = T_old</span>

        <span class="c1"># array of ice mass fractions</span>
        <span class="n">w_i_new</span> <span class="o">=</span> <span class="n">m_i_eq</span> <span class="o">/</span> <span class="p">(</span><span class="n">mass_water</span> <span class="o">+</span> <span class="n">mass_solute</span><span class="p">)</span>

        <span class="n">Nt_solid</span> <span class="o">=</span> <span class="n">Nt_exp</span> <span class="o">-</span> <span class="n">i_end</span>

        <span class="c1"># Preallocation of arrays for saving results from the cooling stage.</span>
        <span class="n">solid_temp_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_save_solid</span><span class="p">,</span> <span class="n">Nz</span><span class="p">,</span> <span class="n">Nr</span><span class="p">))</span>
        <span class="n">solid_ice_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_save_solid</span><span class="p">,</span> <span class="n">Nz</span><span class="p">,</span> <span class="n">Nr</span><span class="p">))</span>
        <span class="n">solid_shelf_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_save_solid</span><span class="p">)</span>
        <span class="n">solid_time_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_save_solid</span><span class="p">)</span>
        <span class="n">i_save</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># FDM scheme for solving the heat conduction equation</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">T_shelf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">T_shelf_cool</span><span class="p">[</span><span class="n">i_end</span><span class="p">:]):</span>
            <span class="c1"># thermal properties</span>
            <span class="c1"># heat capacity</span>
            <span class="n">cp_eff</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">cp_s</span> <span class="o">*</span> <span class="n">solid_fraction</span>
                <span class="o">+</span> <span class="n">cp_i</span> <span class="o">*</span> <span class="n">w_i_new</span>
                <span class="o">+</span> <span class="n">cp_w</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">solid_fraction</span> <span class="o">-</span> <span class="n">w_i_new</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># heat conductivity</span>
            <span class="n">k_eff</span> <span class="o">=</span> <span class="n">lambda_i</span> <span class="o">*</span> <span class="n">w_i_new</span> <span class="o">+</span> <span class="n">lambda_w</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w_i_new</span><span class="p">)</span>
            <span class="c1"># heat diffusivity</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">k_eff</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_eff</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">)</span>
            <span class="c1"># beta parameter beta = beta(t,z,r)</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">Dh</span> <span class="o">*</span> <span class="n">k_f</span> <span class="o">*</span> <span class="n">mass_solute</span> <span class="o">/</span> <span class="p">(</span><span class="n">M_s</span> <span class="o">*</span> <span class="n">rho_l</span> <span class="o">*</span> <span class="n">V</span> <span class="o">*</span> <span class="n">cp_eff</span><span class="p">)</span>
            <span class="c1"># the total nonlinear capacitance term</span>
            <span class="n">BETA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nr</span><span class="p">))</span> <span class="o">*</span> <span class="n">LCS_i_r</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">/</span> <span class="p">(</span><span class="n">T_k</span> <span class="o">-</span> <span class="n">T_m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">LCS_i</span>

            <span class="c1"># Boundary condition at the bottom, z = 0.</span>
            <span class="c1"># overall heat flux</span>
            <span class="n">q_overall</span> <span class="o">=</span> <span class="n">K_shelf</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_shelf</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
            <span class="c1"># q_overall = sigma_B*(T_shelf**4 - T_old[0,:]**4)</span>
            <span class="c1"># boundary condition on the bottom of the vial: ghost grid point</span>
            <span class="n">T_bottom</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">q_overall</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;configuration&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;VISF&quot;</span><span class="p">:</span>
                <span class="c1"># temperature at the top of the liquid</span>
                <span class="n">T_l</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="c1"># vapour temperature</span>
                <span class="n">T_v</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="c1"># vapour pressure</span>
                <span class="n">p_vap</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">vapour_pressure_solid</span><span class="p">(</span><span class="n">T_l</span><span class="p">)</span>

                <span class="c1"># evaporative heat flux (only in the span of vacuum, hold_2)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">t_nuc</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">t_vac_start</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">t_nuc</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">t_vac_start</span> <span class="o">+</span> <span class="n">t_vac_duration</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>
                <span class="p">):</span>
                    <span class="c1"># vapour flux</span>
                    <span class="n">N_w</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">vapour_flux</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span> <span class="n">m_water</span><span class="p">,</span> <span class="n">k_B</span><span class="p">,</span> <span class="n">p_vac</span><span class="p">,</span> <span class="n">p_vap</span><span class="p">,</span> <span class="n">T_l</span><span class="p">,</span> <span class="n">T_v</span><span class="p">)</span>
                    <span class="c1"># evaporative heat flux</span>
                    <span class="n">q_e</span> <span class="o">=</span> <span class="o">-</span><span class="n">N_w</span> <span class="o">*</span> <span class="n">dHe</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">q_e</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">q_e</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># boundary condition in the top of the vial</span>
            <span class="n">T_top</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">q_e</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># boundary condition at the side of the vial</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;configuration&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;jacket&quot;</span><span class="p">:</span>
                <span class="c1"># jacket heat flux</span>
                <span class="n">q_jacket</span> <span class="o">=</span> <span class="n">K_wall</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_shelf</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[:,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no cooling from jacket</span>
                <span class="n">q_jacket</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># boundary condition in the top of the vial</span>
            <span class="n">T_edge</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[:,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">q_jacket</span> <span class="o">*</span> <span class="n">dz</span> <span class="o">/</span> <span class="n">k_eff</span><span class="p">[:,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Boundary condition in the centre, r = 0.</span>
            <span class="c1"># axial symmetry</span>
            <span class="n">T_center</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Bottom boundary points: z = 0.</span>
            <span class="c1"># bottom-centre: r = 0</span>
            <span class="n">T_new</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_bottom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_bottom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">BETA</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># bottom corner (left or right - symmetry): r = R</span>
            <span class="n">T_new</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_bottom</span><span class="p">[</span><span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_bottom</span><span class="p">[</span><span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">BETA</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># the rest of the bottom: 0 &lt; r &lt; R</span>
            <span class="n">T_new</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_bottom</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_bottom</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">BETA</span><span class="p">[</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">]</span> <span class="o">**</span> <span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span>
            <span class="p">)</span>

            <span class="c1"># Top boundary points: z = H.</span>
            <span class="c1"># top centre: r = 0</span>
            <span class="n">T_new</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">2</span>
                <span class="o">*</span> <span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_center</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_center</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_top</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">BETA</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># top edge corner (left or right - symmetry): r = R</span>
            <span class="n">T_new</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_edge</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_edge</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_top</span><span class="p">[</span><span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_edge</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_top</span><span class="p">[</span><span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">BETA</span><span class="p">[</span>
                <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">]</span> <span class="o">**</span> <span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span>
            <span class="p">)</span>

            <span class="c1"># the rest of the vial&#39;s top: 0 &lt; r &lt; R</span>
            <span class="n">T_new</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_top</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span>
                    <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">T_top</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">BETA</span><span class="p">[</span>
                <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">]</span> <span class="o">**</span> <span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span>
            <span class="p">)</span>

            <span class="c1"># Outer boundary points: r = R.</span>
            <span class="c1"># curved cylinder surface in contact with air: 0 &lt; z &lt; H</span>
            <span class="n">T_new</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_edge</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_edge</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">T_edge</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">T_k</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">BETA</span><span class="p">[</span>
                <span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">]</span> <span class="o">**</span> <span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span>
            <span class="p">)</span>

            <span class="c1"># Center boundary points: r = R.</span>
            <span class="c1"># symmetry boundary condition in the centre of the cylinder: 0 &lt; z &lt; H</span>
            <span class="n">T_new</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">2</span>
                <span class="o">*</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_center</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_center</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">BETA</span><span class="p">[</span>
                <span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
            <span class="p">]</span> <span class="o">**</span> <span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span>
            <span class="p">)</span>

            <span class="c1"># Bulk of the vial points: : 0 &lt; z &lt; H &amp; 0 &lt; r &lt; R.</span>
            <span class="c1"># all the other points in the domain</span>
            <span class="n">T_new</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">rho_l</span><span class="p">)</span>
            <span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dr</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">k_eff</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">T_k</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">Nr</span><span class="p">]</span>
                    <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="n">dr</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">+</span> <span class="n">k_eff</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="n">T_k</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">Nz</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">T_k</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="n">dz</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span> <span class="o">*</span> <span class="n">BETA</span><span class="p">[</span>
                <span class="mi">1</span> <span class="p">:</span> <span class="n">Nz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">Nr</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">]</span> <span class="o">**</span> <span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span>
            <span class="p">)</span>

            <span class="c1"># update temperatures</span>
            <span class="n">T_k</span> <span class="o">=</span> <span class="n">T_new</span>

            <span class="c1"># Check for local supercooling.</span>
            <span class="n">LCS_i</span> <span class="o">=</span> <span class="n">T_k</span> <span class="o">&lt;</span> <span class="n">T_eq_l</span>
            <span class="c1"># the not so supercool part</span>
            <span class="n">LCS_i_r</span> <span class="o">=</span> <span class="o">~</span><span class="n">LCS_i</span>

            <span class="c1"># ice mass distribution</span>
            <span class="n">m_ice</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nr</span><span class="p">))</span> <span class="o">*</span> <span class="n">LCS_i_r</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">mass_water</span> <span class="o">-</span> <span class="n">mass_solute</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_f</span> <span class="o">/</span> <span class="n">M_s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">T_m</span> <span class="o">-</span> <span class="n">T_new</span><span class="p">))</span> <span class="o">*</span> <span class="n">LCS_i</span>
            <span class="p">)</span>
            <span class="c1"># ice mass fraction distribution</span>
            <span class="n">w_i_new</span> <span class="o">=</span> <span class="n">m_ice</span> <span class="o">/</span> <span class="p">(</span><span class="n">mass_water</span> <span class="o">+</span> <span class="n">mass_solute</span><span class="p">)</span>

            <span class="c1"># sparse saving</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">Nt_solid</span> <span class="o">/</span> <span class="n">N_save_solid</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># saving temperature profiles</span>
                <span class="n">solid_temp_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">T_new</span> <span class="o">-</span> <span class="mf">273.15</span>
                <span class="c1"># saving ice mass fractions</span>
                <span class="n">solid_ice_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">w_i_new</span>
                <span class="c1"># shelf temperature</span>
                <span class="n">solid_shelf_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_shelf</span> <span class="o">-</span> <span class="mf">273.15</span>
                <span class="c1"># saving sparse time array</span>
                <span class="n">solid_time_results</span><span class="p">[</span><span class="n">i_save</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_nuc</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span>
                <span class="c1"># update saving index</span>
                <span class="n">i_save</span> <span class="o">=</span> <span class="n">i_save</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># solidification sigma</span>
            <span class="n">w_i_r</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">simps</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">w_i_new</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
            <span class="n">w_i</span> <span class="o">=</span> <span class="n">simps</span><span class="p">(</span><span class="n">w_i_r</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">sigma_new</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="n">w_i</span> <span class="o">*</span> <span class="n">mass</span> <span class="o">/</span> <span class="p">(</span><span class="n">mass</span> <span class="o">-</span> <span class="n">mass_solute</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># save solidification time</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_sol&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sigma_new</span> <span class="o">&gt;=</span> <span class="mf">0.9</span><span class="p">):</span>
                <span class="n">Nt_sol_end</span> <span class="o">=</span> <span class="n">i</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_sol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">60</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_nuc</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span>

        <span class="c1"># check if solidification is completed</span>
        <span class="k">if</span> <span class="n">Nt_sol_end</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Solidification is not completed, prolong process time.&quot;</span><span class="p">)</span>

        <span class="c1"># temperature distributions in the product</span>
        <span class="n">temp_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">cooling_temp_results</span><span class="p">[:</span> <span class="n">i_save_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                <span class="n">solid_temp_results</span><span class="p">[:</span> <span class="n">i_save</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">),</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># ice mass fraction results</span>
        <span class="n">ice_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">cooling_ice_results</span><span class="p">[:</span> <span class="n">i_save_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                <span class="n">solid_ice_results</span><span class="p">[:</span> <span class="n">i_save</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">),</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># total time array</span>
        <span class="n">time_results</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">cooling_time_results</span><span class="p">[:</span> <span class="n">i_save_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">solid_time_results</span><span class="p">[:</span> <span class="n">i_save</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="p">),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="mi">3600</span>
        <span class="p">)</span>

        <span class="c1"># total shelf temperature array</span>
        <span class="n">shelf_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">cooling_shelf_results</span><span class="p">[:</span> <span class="n">i_save_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">solid_shelf_results</span><span class="p">[:</span> <span class="n">i_save</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># save reuslts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_domain</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span> <span class="o">=</span> <span class="p">(</span><span class="n">T_eq_l</span><span class="p">,</span> <span class="n">w_s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nuc</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_nuc</span><span class="p">,</span> <span class="n">T_nuc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="n">time_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shelfTemp</span> <span class="o">=</span> <span class="n">shelf_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp</span> <span class="o">=</span> <span class="n">temp_results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iceMassFraction</span> <span class="o">=</span> <span class="n">ice_results</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;T_nuc_min&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;T_nuc_kin&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;T_nuc_mean&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;T_nuc_max&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_nuc&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_sol&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">],</span>
        <span class="p">]</span>

    <span class="c1"># -------------------------------------------------------------------------- #</span>
    <span class="c1"># Plotting functions</span>
    <span class="c1"># -------------------------------------------------------------------------- #</span>

    <span class="c1"># plot distribution of the desired variable</span>
<div class="viewcode-block" id="Snowing.plot_cdf"><a class="viewcode-back" href="../../api/ethz_snow.html#ethz_snow.snowing.Snowing.plot_cdf">[docs]</a>    <span class="k">def</span> <span class="nf">plot_cdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;t_nuc&quot;</span><span class="p">,</span> <span class="n">comp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create CDF plots for Snowing object.</span>

<span class="sd">        Args:</span>
<span class="sd">            what (str, optional): What to plot, i.e., keys of the stats dict.</span>
<span class="sd">                Valid options are t_nuc, T_nuc, t_sol, t_fr.</span>
<span class="sd">                Defaults to &quot;t_nuc&quot;. Also accepting t_nucleation, T_nucleation</span>
<span class="sd">                and t_solidification.</span>
<span class="sd">            comp (bool, optional): If complementary CDF is plotted. Defaults to False.</span>

<span class="sd">        Args:</span>
<span class="sd">            what (str, optional): What to plot, i.e., keys of the stats dict.</span>
<span class="sd">                Valid options are t_nuc, T_nuc, t_sol, t_fr.</span>
<span class="sd">                Defaults to &quot;t_nuc&quot;. Also accepting t_nucleation, T_nucleation</span>
<span class="sd">                and t_solidification.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: This plot not available for single vial simulation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># plot settings</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;axes.axisbelow&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;xtick.direction&quot;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ytick.direction&quot;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span>
                <span class="s2">&quot;xtick.bottom&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;xtick.top&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;ytick.left&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;ytick.right&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># enable this plot only for Nrep &gt; 1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;This plot only available for multiple simulations. &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Run with Nrep &gt; 1.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># plot settings</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;lines.linewidth&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;axes.axisbelow&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;xtick.direction&quot;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ytick.direction&quot;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span>
                <span class="s2">&quot;xtick.bottom&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;xtick.top&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;ytick.left&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;ytick.right&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># align the names with Snowfall and Snowflake</span>
        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;t_nucleation&quot;</span><span class="p">:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="s2">&quot;t_nuc&quot;</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;T_nucleation&quot;</span><span class="p">:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="s2">&quot;T_nuc&quot;</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;t_solidification&quot;</span><span class="p">:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="s2">&quot;t_sol&quot;</span>

        <span class="c1"># if nucleation temperatures requested change complementary to True</span>
        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;T_nuc&quot;</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># get data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_statsMultiple_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>

        <span class="c1"># plot attributes</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;T_nuc&quot;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;nucleation temperature, $T^</span><span class="si">{nuc}</span><span class="s2">$ [°C]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;nucleation temperature CDF, $F_</span><span class="si">{nT}</span><span class="s2">$ [K$^{-1}$]&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;t_nuc&quot;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;nucleation time, $t^</span><span class="si">{nuc}</span><span class="s2">$ [min]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;nucleation time CDF, $F_</span><span class="si">{nt}</span><span class="s2">$ [min$^{-1}$]&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;t_sol&quot;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;solidification time, $t^</span><span class="si">{sol}</span><span class="s2">$ [min]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;solidification time CDF, $F_</span><span class="si">{sol}</span><span class="s2">$ [min$^{-1}$]&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;t_fr&quot;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;complete freezing time, $t^</span><span class="si">{fr}</span><span class="s2">$ [min]&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;frrozen product time CDF, $F_</span><span class="si">{fr}</span><span class="s2">$ [min$^{-1}$]&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Property to plot incorrectly specified. Use &quot;T_nuc&quot;, &quot;t_nuc&quot;, &quot;t_sol&quot; or &quot;t_fr&quot; instead.&#39;</span>
            <span class="p">)</span>

        <span class="c1"># plot different nucleation temperatures for spatial models</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;dimensionality&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;homogeneous&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;T_nuc&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_df_Tnuc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statsMultiple_df</span><span class="p">[</span>
                <span class="p">[</span><span class="s2">&quot;T_nuc_min&quot;</span><span class="p">,</span> <span class="s2">&quot;T_nuc_kin&quot;</span><span class="p">,</span> <span class="s2">&quot;T_nuc_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;T_nuc_max&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">ecdfplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_df_Tnuc</span><span class="p">,</span> <span class="n">complementary</span><span class="o">=</span><span class="n">comp</span><span class="p">)</span>
        <span class="c1"># in other cases, just plot the desired quantity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">ecdfplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_statsMultiple_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">complementary</span><span class="o">=</span><span class="n">comp</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    <span class="c1"># plot the stats (categorical plots) of whichever desired variable</span>
<div class="viewcode-block" id="Snowing.plot"><a class="viewcode-back" href="../../api/ethz_snow.html#ethz_snow.snowing.Snowing.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;t_nuc&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;box&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create categorical plots for Snowing object.</span>

<span class="sd">        Args:</span>
<span class="sd">            what (str, optional): What to plot, i.e., keys of the stats dict.</span>
<span class="sd">                Valid options are t_nuc, T_nuc, t_sol, t_fr.</span>
<span class="sd">                Defaults to &quot;t_nuc&quot;. Also accepting t_nucleation, T_nucleation</span>
<span class="sd">                and t_solidification.</span>
<span class="sd">            kind (str, optional): Any sns.catplot &#39;kind&#39; input is allowed.</span>
<span class="sd">                Defaults to &quot;box&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># enable this plot only for Nrep &gt; 1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;This plot is only available for multiple simulations. &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Run with Nrep &gt; 1.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># plot settings</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;axes.axisbelow&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;xtick.direction&quot;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ytick.direction&quot;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span>
                <span class="s2">&quot;xtick.bottom&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;xtick.top&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;ytick.left&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;ytick.right&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># align the names with Snowfall and Snowflake</span>
        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;t_nucleation&quot;</span><span class="p">:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="s2">&quot;t_nuc&quot;</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;T_nucleation&quot;</span><span class="p">:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="s2">&quot;T_nuc&quot;</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;t_solidification&quot;</span><span class="p">:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="s2">&quot;t_sol&quot;</span>

        <span class="c1"># get data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_statsMultiple_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>

        <span class="c1"># plot different nucleation temperatures for spatial models</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;dimensionality&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;homogeneous&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;T_nuc&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_df_Tnuc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_statsMultiple_df</span><span class="p">[</span>
                <span class="p">[</span><span class="s2">&quot;T_nuc_min&quot;</span><span class="p">,</span> <span class="s2">&quot;T_nuc_kin&quot;</span><span class="p">,</span> <span class="s2">&quot;T_nuc_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;T_nuc_max&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">catplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_df_Tnuc</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>
        <span class="c1"># in other cases, just plot the desired quantity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">catplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_statsMultiple_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">what</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span></div>

    <span class="c1"># plot the temperature evolution</span>
    <span class="k">def</span> <span class="nf">_plot_temperature_evolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># temperature evolution plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="c1"># plot nucleation time and equilibrum temperature</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_nuc&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_nuc&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">],</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_shelfTemp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shelfTemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5</span><span class="p">],</span>
            <span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$t = t^</span><span class="si">{nuc}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># plot time of frozen product</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_shelfTemp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shelfTemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5</span><span class="p">],</span>
                <span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;indigo&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$t = t^</span><span class="si">{fr}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">0.05</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">273.15</span><span class="p">],</span>
            <span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;magenta&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$T = T^</span><span class="si">{eq}</span><span class="s2">_</span><span class="si">{l}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># plot shelf temperature evolution</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shelfTemp</span><span class="p">,</span> <span class="s2">&quot;b-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;shelf T&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;dimensionality&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;homogeneous&quot;</span><span class="p">:</span>
            <span class="c1"># plot temperature evolution for homogeneous model</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp</span><span class="p">,</span> <span class="s2">&quot;k-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;product T&quot;</span><span class="p">)</span>

        <span class="c1"># access legend objects automatically created from data</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># plot product temperature evolution for 1D case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;dimensionality&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;spatial_1D&quot;</span><span class="p">:</span>
            <span class="c1"># colors</span>
            <span class="n">colors</span><span class="p">,</span> <span class="n">my_cmap</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">colormap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">)</span>
            <span class="c1"># plot temperature evolution for different vertical positions</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">)</span> <span class="o">/</span> <span class="mi">11</span><span class="p">)):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
            <span class="c1"># colorbar</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">my_cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;dimensionless vertical position, z/H [-]&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
            <span class="c1"># add colormap to the legend entries</span>
            <span class="n">cmaps_gradients</span> <span class="o">=</span> <span class="n">my_cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
            <span class="c1"># combine patches into a list and add to the handles and labels</span>
            <span class="n">cmap_patches</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmaps_gradients</span>
            <span class="p">]</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmap_patches</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;product T&quot;</span><span class="p">)</span>

        <span class="c1"># plot product temperature evolution for 2D case</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;dimensionality&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;spatial_2D&quot;</span><span class="p">:</span>
            <span class="c1"># colors</span>
            <span class="n">colors</span><span class="p">,</span> <span class="n">my_cmap</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">colormap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># plot temperature evolution for different vertical positions</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">11</span><span class="p">)):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span>
                <span class="p">)</span>
            <span class="c1"># colorbar</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">my_cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span>
                <span class="s2">&quot;dimensionless vertical position (at r = 0), z/H [-]&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span>
            <span class="p">)</span>
            <span class="c1"># add colormap to the legend entries</span>
            <span class="n">cmaps_gradients</span> <span class="o">=</span> <span class="n">my_cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
            <span class="c1"># combine patches into a list and add to the handles and labels</span>
            <span class="n">cmap_patches</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmaps_gradients</span>
            <span class="p">]</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmap_patches</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;product T&quot;</span><span class="p">)</span>

        <span class="c1"># plot labels and attributes</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;process time, $t$ [h]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;temperature, $T$ [°C]&quot;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shelfTemp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shelfTemp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Product temperature evolution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">handler_map</span><span class="o">=</span><span class="p">{</span><span class="nb">list</span><span class="p">:</span> <span class="n">HandlerTuple</span><span class="p">(</span><span class="n">ndivide</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">)},</span>
            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># plot ice mass fraction evolution</span>
    <span class="k">def</span> <span class="nf">_plot_ice_mass_fraction_evolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ice mass fraction plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="c1"># plot lines for nucleation time and maximum ice mass fraction</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_nuc&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_nuc&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">],</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">],</span>
            <span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$t = t^</span><span class="si">{nuc}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># plot time of frozen product</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">[</span><span class="s2">&quot;t_fr&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">60</span><span class="p">],</span>
                <span class="p">[</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">],</span>
                <span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;indigo&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$t = t^</span><span class="si">{fr}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="o">-</span><span class="mf">0.05</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
            <span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prop</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$w_</span><span class="si">{i}</span><span class="s2"> = 1 - w_</span><span class="si">{s}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;dimensionality&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;homogeneous&quot;</span><span class="p">:</span>
            <span class="c1"># plot temperature evolution for homogeneous model</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_iceMassFraction</span><span class="p">,</span>
                <span class="s2">&quot;k-&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;product $w_</span><span class="si">{i}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># access legend objects automatically created from data</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># plot product temperature evolution for 1D case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;dimensionality&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;spatial_1D&quot;</span><span class="p">:</span>
            <span class="c1"># colors</span>
            <span class="n">colors</span><span class="p">,</span> <span class="n">my_cmap</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">colormap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">)</span>
            <span class="c1"># colorbar</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">my_cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;dimensionless vertical position, z/H [-]&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
            <span class="c1"># plot temperature evolution for different vertical positions</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">)</span> <span class="o">/</span> <span class="mi">11</span><span class="p">)):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_iceMassFraction</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># add colormap to the legend entries</span>
            <span class="n">cmaps_gradients</span> <span class="o">=</span> <span class="n">my_cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
            <span class="c1"># combine patches into a list and add to the handles and labels</span>
            <span class="n">cmap_patches</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmaps_gradients</span>
            <span class="p">]</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmap_patches</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;product $w_</span><span class="si">{i}</span><span class="s2">$&quot;</span><span class="p">)</span>

        <span class="c1"># plot product temperature evolution for 2D case</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s2">&quot;dimensionality&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;spatial_2D&quot;</span><span class="p">:</span>
            <span class="c1"># colors</span>
            <span class="n">colors</span><span class="p">,</span> <span class="n">my_cmap</span><span class="p">,</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">Utils</span><span class="o">.</span><span class="n">colormap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># colorbar</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">my_cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span>
                <span class="s2">&quot;dimensionless vertical position (at r = 0), z/H [-]&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span>
            <span class="p">)</span>
            <span class="c1"># plot temperature evolution for different vertical positions</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">11</span><span class="p">)):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_iceMassFraction</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># add colormap to the legend entries</span>
            <span class="n">cmaps_gradients</span> <span class="o">=</span> <span class="n">my_cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
            <span class="c1"># combine patches into a list and add to the handles and labels</span>
            <span class="n">cmap_patches</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">patches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmaps_gradients</span>
            <span class="p">]</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmap_patches</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;product $w_</span><span class="si">{i}</span><span class="s2">$&quot;</span><span class="p">)</span>

        <span class="c1"># plot labels and attributes</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;process time, $t$ [h]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;ice mass fraction, $w_i$ [-]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;solid&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Ice mass fraction evolution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="n">handles</span><span class="o">=</span><span class="n">handles</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">handler_map</span><span class="o">=</span><span class="p">{</span><span class="nb">list</span><span class="p">:</span> <span class="n">HandlerTuple</span><span class="p">(</span><span class="n">ndivide</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">)},</span>
            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># plot evolution function</span>
<div class="viewcode-block" id="Snowing.plot_evolution"><a class="viewcode-back" href="../../api/ethz_snow.html#ethz_snow.snowing.Snowing.plot_evolution">[docs]</a>    <span class="k">def</span> <span class="nf">plot_evolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;temperature&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to plot the spatial evolution of temperature or ice mass fractions.</span>

<span class="sd">        Args:</span>
<span class="sd">            what (str, optional): Quantity to be plotted. Defaults to &quot;temperature&quot;.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: This plotting functionality is only implemented for single simulations (when Nrep = 1), otherwise, an error is raised.</span>
<span class="sd">            ValueError: Raises error if quantity for plotting is incorrectly specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># plot settings</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;axes.axisbelow&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;xtick.direction&quot;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ytick.direction&quot;</span><span class="p">:</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span>
                <span class="s2">&quot;xtick.bottom&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;xtick.top&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;ytick.left&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;ytick.right&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;This plot only available for single simulations. &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Run with Nrep = 1.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_temperature_evolution</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s2">&quot;ice_mass_fraction&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_ice_mass_fraction_evolution</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Property to plot incorrectly specified. Use &quot;temperature&quot; or &quot;ice_mass_fraction&quot; instead.&#39;</span>
            <span class="p">)</span></div>

    <span class="c1"># repr function</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return string representation of the Snowing class.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The Snowing class string representation giving some basic info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Snowing([</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span><span class="si">}</span><span class="s2"> Snowing</span><span class="si">{</span><span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Nrep</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;dimensionality: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s1">&#39;dimensionality&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;configuration: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">const</span><span class="p">[</span><span class="s1">&#39;configuration&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">])&quot;</span>
        <span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021-2024, Leif-Thore Deck, Andraž Košir, David Ochsenbein.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> and ❤️  using a custom <a href="https://github.com/LinxiFan/Stanford-theme">theme</a> based on <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.1.0.post1.dev34+ga1dec07.d20230707',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/documentation_options.js"></script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>